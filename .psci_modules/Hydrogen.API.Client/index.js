// | Generic HTTP API client infrastructure
// |
// | This module provides a typed HTTP client with:
// | - Configuration (base URL, auth token)
// | - JSON encoding/decoding via Argonaut
// | - Error handling with descriptive messages
// | - Request logging (configurable)
// |
// | ## Usage
// |
// | ```purescript
// | -- Define your config
// | config :: ApiConfig
// | config = defaultConfig 
// |   { baseUrl = "https://api.example.com"
// |   } # withAuth myToken
// |
// | -- Make requests
// | getUsers :: Aff (Either String (Array User))
// | getUsers = get config "/users"
// |
// | createUser :: User -> Aff (Either String User)
// | createUser user = post config "/users" user
// | ```
import * as Affjax from "../Affjax/index.js";
import * as Affjax_RequestBody from "../Affjax.RequestBody/index.js";
import * as Affjax_RequestHeader from "../Affjax.RequestHeader/index.js";
import * as Affjax_ResponseFormat from "../Affjax.ResponseFormat/index.js";
import * as Affjax_Web from "../Affjax.Web/index.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Argonaut_Decode_Class from "../Data.Argonaut.Decode.Class/index.js";
import * as Data_Argonaut_Decode_Error from "../Data.Argonaut.Decode.Error/index.js";
import * as Data_Argonaut_Encode_Class from "../Data.Argonaut.Encode.Class/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_HTTP_Method from "../Data.HTTP.Method/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
var when = /* #__PURE__ */ Control_Applicative.when(Effect_Aff.applicativeAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit)(Effect_Aff.bindAff);
var bind = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var show = /* #__PURE__ */ Data_Show.show(Data_HTTP_Method.showMethod);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);

// | Enable/disable request logging
var withLogging = function (enabled) {
    return function (config) {
        return {
            baseUrl: config.baseUrl,
            authToken: config.authToken,
            logging: enabled
        };
    };
};

// | Add Bearer token authentication to config
var withAuth = function (token) {
    return function (config) {
        return {
            baseUrl: config.baseUrl,
            logging: config.logging,
            authToken: new Data_Maybe.Just(token)
        };
    };
};
var logSuccess = function (config) {
    return function (method) {
        return function (url) {
            return when(config.logging)(liftEffect(Effect_Console.log("[API] " + (method + (" " + (url + " OK"))))));
        };
    };
};
var logRequest = function (config) {
    return function (method) {
        return function (url) {
            return when(config.logging)(liftEffect(Effect_Console.log("[API] " + (method + (" " + url)))));
        };
    };
};
var logError = function (config) {
    return function (method) {
        return function (url) {
            return function (err) {
                return when(config.logging)(liftEffect(Effect_Console.error("[API] " + (method + (" " + (url + (" FAILED: " + err)))))));
            };
        };
    };
};

// ============================================================
// HELPERS
// ============================================================
var headers = function (config) {
    if (config.authToken instanceof Data_Maybe.Nothing) {
        return [ new Affjax_RequestHeader.ContentType("application/json") ];
    };
    if (config.authToken instanceof Data_Maybe.Just) {
        return [ new Affjax_RequestHeader.ContentType("application/json"), new Affjax_RequestHeader.RequestHeader("Authorization", "Bearer " + config.authToken.value0) ];
    };
    throw new Error("Failed pattern match at Hydrogen.API.Client (line 176, column 18 - line 181, column 6): " + [ config.authToken.constructor.name ]);
};

// | Perform a DELETE request (no response body expected)
var $$delete = function (config) {
    return function (path) {
        var url = config.baseUrl + path;
        return discard(logRequest(config)("DELETE")(url))(function () {
            return bind(Affjax_Web.request({
                content: Affjax.defaultRequest.content,
                username: Affjax.defaultRequest.username,
                password: Affjax.defaultRequest.password,
                withCredentials: Affjax.defaultRequest.withCredentials,
                timeout: Affjax.defaultRequest.timeout,
                url: url,
                method: new Data_Either.Left(Data_HTTP_Method.DELETE.value),
                headers: headers(config),
                responseFormat: Affjax_ResponseFormat.json
            }))(function (result) {
                if (result instanceof Data_Either.Left) {
                    var errMsg = Affjax.printError(result.value0);
                    return discard(logError(config)("DELETE")(url)(errMsg))(function () {
                        return pure(new Data_Either.Left(errMsg));
                    });
                };
                if (result instanceof Data_Either.Right) {
                    return discard(logSuccess(config)("DELETE")(url))(function () {
                        return pure(new Data_Either.Right(Data_Unit.unit));
                    });
                };
                throw new Error("Failed pattern match at Hydrogen.API.Client (line 126, column 3 - line 133, column 24): " + [ result.constructor.name ]);
            });
        });
    };
};

// | Default configuration with empty base URL and no auth
var defaultConfig = /* #__PURE__ */ (function () {
    return {
        baseUrl: "",
        authToken: Data_Maybe.Nothing.value,
        logging: false
    };
})();
var decode = function (dictDecodeJson) {
    var decodeJson = Data_Argonaut_Decode_Class.decodeJson(dictDecodeJson);
    return function (json) {
        var v = decodeJson(json);
        if (v instanceof Data_Either.Left) {
            return new Data_Either.Left(Data_Argonaut_Decode_Error.printJsonDecodeError(v.value0));
        };
        if (v instanceof Data_Either.Right) {
            return new Data_Either.Right(v.value0);
        };
        throw new Error("Failed pattern match at Hydrogen.API.Client (line 184, column 15 - line 186, column 25): " + [ v.constructor.name ]);
    };
};

// ============================================================
// LOW-LEVEL REQUEST
// ============================================================
// | Perform an HTTP request with optional JSON body
var request = function (dictEncodeJson) {
    var encodeJson = Data_Argonaut_Encode_Class.encodeJson(dictEncodeJson);
    return function (dictDecodeJson) {
        var decode1 = decode(dictDecodeJson);
        return function (config) {
            return function (method) {
                return function (path) {
                    return function (maybeBody) {
                        var url = config.baseUrl + path;
                        var methodStr = show(method);
                        return discard(logRequest(config)(methodStr)(url))(function () {
                            return bind(Affjax_Web.request({
                                username: Affjax.defaultRequest.username,
                                password: Affjax.defaultRequest.password,
                                withCredentials: Affjax.defaultRequest.withCredentials,
                                timeout: Affjax.defaultRequest.timeout,
                                url: url,
                                method: new Data_Either.Left(method),
                                headers: headers(config),
                                content: map(function ($47) {
                                    return Affjax_RequestBody.json(encodeJson($47));
                                })(maybeBody),
                                responseFormat: Affjax_ResponseFormat.json
                            }))(function (result) {
                                if (result instanceof Data_Either.Left) {
                                    var errMsg = Affjax.printError(result.value0);
                                    return discard(logError(config)(methodStr)(url)(errMsg))(function () {
                                        return pure(new Data_Either.Left(errMsg));
                                    });
                                };
                                if (result instanceof Data_Either.Right) {
                                    return discard(logSuccess(config)(methodStr)(url))(function () {
                                        return pure(decode1(result.value0.body));
                                    });
                                };
                                throw new Error("Failed pattern match at Hydrogen.API.Client (line 162, column 3 - line 169, column 34): " + [ result.constructor.name ]);
                            });
                        });
                    };
                };
            };
        };
    };
};
var request1 = /* #__PURE__ */ request(Data_Argonaut_Encode_Class.encodeJsonUnit);

// ============================================================
// HTTP METHODS
// ============================================================
// | Perform a GET request
var get = function (dictDecodeJson) {
    var request2 = request1(dictDecodeJson);
    return function (config) {
        return function (path) {
            return request2(config)(Data_HTTP_Method.GET.value)(path)(Data_Maybe.Nothing.value);
        };
    };
};

// | Perform a PATCH request with JSON body
var patch = function (dictEncodeJson) {
    var request2 = request(dictEncodeJson);
    return function (dictDecodeJson) {
        var request3 = request2(dictDecodeJson);
        return function (config) {
            return function (path) {
                return function (body) {
                    return request3(config)(Data_HTTP_Method.PATCH.value)(path)(new Data_Maybe.Just(body));
                };
            };
        };
    };
};

// | Perform a POST request with JSON body
var post = function (dictEncodeJson) {
    var request2 = request(dictEncodeJson);
    return function (dictDecodeJson) {
        var request3 = request2(dictDecodeJson);
        return function (config) {
            return function (path) {
                return function (body) {
                    return request3(config)(Data_HTTP_Method.POST.value)(path)(new Data_Maybe.Just(body));
                };
            };
        };
    };
};

// | Perform a PUT request with JSON body
var put = function (dictEncodeJson) {
    var request2 = request(dictEncodeJson);
    return function (dictDecodeJson) {
        var request3 = request2(dictDecodeJson);
        return function (config) {
            return function (path) {
                return function (body) {
                    return request3(config)(Data_HTTP_Method.PUT.value)(path)(new Data_Maybe.Just(body));
                };
            };
        };
    };
};
export {
    defaultConfig,
    withAuth,
    withLogging,
    get,
    post,
    put,
    patch,
    $$delete as delete,
    request
};
