// | Static HTML string renderer for Halogen
// |
// | Renders `HH.HTML w i` to a plain HTML string, suitable for:
// | - Server-side rendering (SSR)
// | - Static site generation (SSG)
// | - SEO-friendly pre-rendering
// |
// | Usage:
// | ```purescript
// | import Hydrogen.HTML.Renderer as Renderer
// | 
// | html :: HH.HTML Void Void
// | html = HH.div [ HP.class_ (ClassName "foo") ] [ HH.text "Hello" ]
// | 
// | rendered :: String
// | rendered = Renderer.render html
// | -- => "<div class=\"foo\">Hello</div>"
// | ```
import * as $foreign from "./foreign.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_String_CodePoints from "../Data.String.CodePoints/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Halogen_VDom_DOM_Prop from "../Halogen.VDom.DOM.Prop/index.js";
import * as Halogen_VDom_Types from "../Halogen.VDom.Types/index.js";
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var foldMap = /* #__PURE__ */ Data_Foldable.foldMap(Data_Foldable.foldableArray)(Data_Monoid.monoidString);

// | Self-closing (void) elements in HTML5
var isSelfClosing = function (v) {
    if (v === "area") {
        return true;
    };
    if (v === "base") {
        return true;
    };
    if (v === "br") {
        return true;
    };
    if (v === "col") {
        return true;
    };
    if (v === "embed") {
        return true;
    };
    if (v === "hr") {
        return true;
    };
    if (v === "img") {
        return true;
    };
    if (v === "input") {
        return true;
    };
    if (v === "link") {
        return true;
    };
    if (v === "meta") {
        return true;
    };
    if (v === "param") {
        return true;
    };
    if (v === "source") {
        return true;
    };
    if (v === "track") {
        return true;
    };
    if (v === "wbr") {
        return true;
    };
    return false;
};

// ============================================================
// ESCAPING
// ============================================================
// | Escape HTML text content
var escapeHtml = function (s) {
    return Data_String_Common.replaceAll(">")("&gt;")(Data_String_Common.replaceAll("<")("&lt;")(Data_String_Common.replaceAll("&")("&amp;")(s)));
};

// | Escape attribute values
var escapeAttr = function (s) {
    return Data_String_Common.replaceAll(">")("&gt;")(Data_String_Common.replaceAll("<")("&lt;")(Data_String_Common.replaceAll("\"")("&quot;")(Data_String_Common.replaceAll("&")("&amp;")(s))));
};

// | Convert a property to an HTML attribute where applicable
var renderPropertyToAttr = function (name) {
    return function (value) {
        var strVal = $foreign.propValueToString(value);
        if (name === "className") {
            return new Data_Maybe.Just("class=\"" + (escapeAttr(strVal) + "\""));
        };
        if (name === "htmlFor") {
            return new Data_Maybe.Just("for=\"" + (escapeAttr(strVal) + "\""));
        };
        if (name === "disabled") {
            var $13 = strVal === "true";
            if ($13) {
                return new Data_Maybe.Just("disabled");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "checked") {
            var $14 = strVal === "true";
            if ($14) {
                return new Data_Maybe.Just("checked");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "readonly") {
            var $15 = strVal === "true";
            if ($15) {
                return new Data_Maybe.Just("readonly");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "required") {
            var $16 = strVal === "true";
            if ($16) {
                return new Data_Maybe.Just("required");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "autofocus") {
            var $17 = strVal === "true";
            if ($17) {
                return new Data_Maybe.Just("autofocus");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "autoplay") {
            var $18 = strVal === "true";
            if ($18) {
                return new Data_Maybe.Just("autoplay");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "controls") {
            var $19 = strVal === "true";
            if ($19) {
                return new Data_Maybe.Just("controls");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "loop") {
            var $20 = strVal === "true";
            if ($20) {
                return new Data_Maybe.Just("loop");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "muted") {
            var $21 = strVal === "true";
            if ($21) {
                return new Data_Maybe.Just("muted");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "hidden") {
            var $22 = strVal === "true";
            if ($22) {
                return new Data_Maybe.Just("hidden");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "selected") {
            var $23 = strVal === "true";
            if ($23) {
                return new Data_Maybe.Just("selected");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "multiple") {
            var $24 = strVal === "true";
            if ($24) {
                return new Data_Maybe.Just("multiple");
            };
            return Data_Maybe.Nothing.value;
        };
        if (name === "open") {
            var $25 = strVal === "true";
            if ($25) {
                return new Data_Maybe.Just("open");
            };
            return Data_Maybe.Nothing.value;
        };
        if (Data_String_CodePoints.take(2)(name) === "on") {
            return Data_Maybe.Nothing.value;
        };
        return new Data_Maybe.Just(name + ("=\"" + (escapeAttr(strVal) + "\"")));
    };
};
var renderProp = function (v) {
    if (v instanceof Halogen_VDom_DOM_Prop.Attribute) {
        var prefix = (function () {
            if (v.value0 instanceof Data_Maybe.Just) {
                return v.value0.value0 + ":";
            };
            if (v.value0 instanceof Data_Maybe.Nothing) {
                return "";
            };
            throw new Error("Failed pattern match at Hydrogen.HTML.Renderer (line 139, column 18 - line 141, column 24): " + [ v.value0.constructor.name ]);
        })();
        return new Data_Maybe.Just(prefix + (v.value1 + ("=\"" + (escapeAttr(v.value2) + "\""))));
    };
    if (v instanceof Halogen_VDom_DOM_Prop.Property) {
        return renderPropertyToAttr(v.value0)(v.value1);
    };
    if (v instanceof Halogen_VDom_DOM_Prop.Handler) {
        return Data_Maybe.Nothing.value;
    };
    if (v instanceof Halogen_VDom_DOM_Prop.Ref) {
        return Data_Maybe.Nothing.value;
    };
    throw new Error("Failed pattern match at Hydrogen.HTML.Renderer (line 137, column 14 - line 153, column 12): " + [ v.constructor.name ]);
};
var renderPropArray = /* #__PURE__ */ (function () {
    var $56 = Data_String_Common.joinWith(" ");
    var $57 = Data_Array.mapMaybe(renderProp);
    return function ($58) {
        return $56($57($58));
    };
})();

// | Render props (attributes/properties) to a string.
// | This uses unsafe coercion because props is an opaque Array (Prop i)
var renderPropsUnsafe = function (props) {
    return renderPropArray($foreign.unsafeToProps(props));
};

// ============================================================
// INTERNAL
// ============================================================
var renderVDom = function ($copy_opts) {
    return function ($copy_v) {
        var $tco_var_opts = $copy_opts;
        var $tco_done = false;
        var $tco_result;
        function $tco_loop(opts, v) {
            if (v instanceof Halogen_VDom_Types.Text) {
                $tco_done = true;
                return escapeHtml(v.value0);
            };
            if (v instanceof Halogen_VDom_Types.Elem) {
                $tco_done = true;
                return renderElement(opts)(v.value0)(v.value1)(v.value2)(v.value3);
            };
            if (v instanceof Halogen_VDom_Types.Keyed) {
                $tco_done = true;
                return renderElement(opts)(v.value0)(v.value1)(v.value2)(map(Data_Tuple.snd)(v.value3));
            };
            if (v instanceof Halogen_VDom_Types.Widget) {
                $tco_done = true;
                return "";
            };
            if (v instanceof Halogen_VDom_Types.Grafted) {
                $tco_var_opts = opts;
                $copy_v = Halogen_VDom_Types.runGraft(v.value0);
                return;
            };
            throw new Error("Failed pattern match at Hydrogen.HTML.Renderer (line 69, column 19 - line 79, column 44): " + [ v.constructor.name ]);
        };
        while (!$tco_done) {
            $tco_result = $tco_loop($tco_var_opts, $copy_v);
        };
        return $tco_result;
    };
};
var renderElement = function (opts) {
    return function (maybeNs) {
        return function (name) {
            return function (props) {
                return function (children) {
                    
                    // We need to render props - but they're opaque here
                    // The actual prop rendering happens via renderProps
var propsStr = renderPropsUnsafe(props);
                    var nsAttr = (function () {
                        if (maybeNs instanceof Data_Maybe.Just) {
                            return " xmlns=\"" + (escapeAttr(maybeNs.value0) + "\"");
                        };
                        if (maybeNs instanceof Data_Maybe.Nothing) {
                            return "";
                        };
                        throw new Error("Failed pattern match at Hydrogen.HTML.Renderer (line 94, column 14 - line 96, column 20): " + [ maybeNs.constructor.name ]);
                    })();
                    var attrsStr = (function () {
                        var $51 = Data_String_Common["null"](propsStr) && Data_String_Common["null"](nsAttr);
                        if ($51) {
                            return "";
                        };
                        return nsAttr + (function () {
                            var $52 = Data_String_Common["null"](propsStr);
                            if ($52) {
                                return "";
                            };
                            return " " + propsStr;
                        })();
                    })();
                    var $53 = Data_Array["null"](children) && (isSelfClosing(name) && opts.selfClosingTags);
                    if ($53) {
                        return "<" + (name + (attrsStr + "/>"));
                    };
                    return "<" + (name + (attrsStr + (">" + (foldMap(renderVDom(opts))(children) + ("</" + (name + ">"))))));
                };
            };
        };
    };
};

// | Render Halogen HTML to a string with custom options.
var renderWith = function (opts) {
    return function (v) {
        return renderVDom(opts)(v);
    };
};

// | Default rendering options
var defaultOptions = {
    selfClosingTags: true,
    prettyPrint: false,
    indent: "  "
};

// | Render Halogen HTML to a string with default options.
// | Widgets are rendered as empty strings (they represent component slots).
var render = /* #__PURE__ */ renderWith(defaultOptions);
export {
    render,
    renderWith,
    defaultOptions
};
