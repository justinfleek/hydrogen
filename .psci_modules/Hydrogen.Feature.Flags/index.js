// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//                                                        // hydrogen // flags
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// | Feature flags and A/B testing system
// |
// | Enables gradual rollouts, experimentation, and runtime configuration
// | without code changes. Supports percentage-based rollouts, user targeting,
// | and variant assignment.
// |
// | ## Usage
// |
// | ```purescript
// | import Hydrogen.Feature.Flags as Flags
// |
// | -- Define flags
// | newFeature = Flags.flag "new-checkout-flow"
// | darkMode = Flags.flag "dark-mode"
// |
// | -- Create a flag provider
// | provider <- Flags.createProvider defaultFlags
// |
// | -- Check if enabled
// | isEnabled <- Flags.isEnabled provider newFeature
// | when isEnabled do
// |   renderNewCheckout
// |
// | -- A/B testing with variants
// | buttonColorTest = Flags.experiment "button-color" ["red", "blue", "green"]
// | variant <- Flags.getVariant provider buttonColorTest
// | ```
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_EuclideanRing from "../Data.EuclideanRing/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_HeytingAlgebra from "../Data.HeytingAlgebra/index.js";
import * as Data_Map from "../Data.Map/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Foreign_Object from "../Foreign.Object/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var not = /* #__PURE__ */ Data_HeytingAlgebra.not(Data_HeytingAlgebra.heytingAlgebraBoolean);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showBoolean);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var $$void = /* #__PURE__ */ Data_Functor["void"](Effect.functorEffect);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var fromFoldable = /* #__PURE__ */ Data_Array.fromFoldable(Data_Set.foldableSet);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var mod = /* #__PURE__ */ Data_EuclideanRing.mod(Data_EuclideanRing.euclideanRingInt);
var elem = /* #__PURE__ */ Data_Array.elem(Data_Eq.eqString);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordString);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var map2 = /* #__PURE__ */ Data_Functor.map(Effect.functorEffect);

// | Targeting conditions
var Percentage = /* #__PURE__ */ (function () {
    function Percentage(value0) {
        this.value0 = value0;
    };
    Percentage.create = function (value0) {
        return new Percentage(value0);
    };
    return Percentage;
})();

// | Targeting conditions
var UserIds = /* #__PURE__ */ (function () {
    function UserIds(value0) {
        this.value0 = value0;
    };
    UserIds.create = function (value0) {
        return new UserIds(value0);
    };
    return UserIds;
})();

// | Targeting conditions
var UserAttribute = /* #__PURE__ */ (function () {
    function UserAttribute(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    UserAttribute.create = function (value0) {
        return function (value1) {
            return new UserAttribute(value0, value1);
        };
    };
    return UserAttribute;
})();

// | Targeting conditions
var Environment = /* #__PURE__ */ (function () {
    function Environment(value0) {
        this.value0 = value0;
    };
    Environment.create = function (value0) {
        return new Environment(value0);
    };
    return Environment;
})();

// | Targeting conditions
var Always = /* #__PURE__ */ (function () {
    function Always() {

    };
    Always.value = new Always();
    return Always;
})();

// | Targeting conditions
var Never = /* #__PURE__ */ (function () {
    function Never() {

    };
    Never.value = new Never();
    return Never;
})();

// | Targeting conditions
var AllOf = /* #__PURE__ */ (function () {
    function AllOf(value0) {
        this.value0 = value0;
    };
    AllOf.create = function (value0) {
        return new AllOf(value0);
    };
    return AllOf;
})();

// | Targeting conditions
var AnyOf = /* #__PURE__ */ (function () {
    function AnyOf(value0) {
        this.value0 = value0;
    };
    AnyOf.create = function (value0) {
        return new AnyOf(value0);
    };
    return AnyOf;
})();

// | A flag value can be boolean, string, number, or JSON
var BoolValue = /* #__PURE__ */ (function () {
    function BoolValue(value0) {
        this.value0 = value0;
    };
    BoolValue.create = function (value0) {
        return new BoolValue(value0);
    };
    return BoolValue;
})();

// | A flag value can be boolean, string, number, or JSON
var StringValue = /* #__PURE__ */ (function () {
    function StringValue(value0) {
        this.value0 = value0;
    };
    StringValue.create = function (value0) {
        return new StringValue(value0);
    };
    return StringValue;
})();

// | A flag value can be boolean, string, number, or JSON
var NumberValue = /* #__PURE__ */ (function () {
    function NumberValue(value0) {
        this.value0 = value0;
    };
    NumberValue.create = function (value0) {
        return new NumberValue(value0);
    };
    return NumberValue;
})();

// | A flag value can be boolean, string, number, or JSON
var JsonValue = /* #__PURE__ */ (function () {
    function JsonValue(value0) {
        this.value0 = value0;
    };
    JsonValue.create = function (value0) {
        return new JsonValue(value0);
    };
    return JsonValue;
})();

// ═══════════════════════════════════════════════════════════════════════════
// Core Types
// ═══════════════════════════════════════════════════════════════════════════
// | A feature flag identifier
var Flag = function (x) {
    return x;
};
var when = function (v) {
    return function (v1) {
        if (v) {
            return v1;
        };
        if (!v) {
            return pure(Data_Unit.unit);
        };
        throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 593, column 1 - line 593, column 46): " + [ v.constructor.name, v1.constructor.name ]);
    };
};

// | Create a user ID targeting rule
var userIds = function (ids) {
    return function (value) {
        return {
            condition: new UserIds(ids),
            value: value
        };
    };
};

// | Create a user attribute targeting rule
var userAttribute = function (attr) {
    return function (predicate) {
        return function (value) {
            return {
                condition: new UserAttribute(attr, predicate),
                value: value
            };
        };
    };
};

// | Track that a user was exposed to an experiment
var trackExposure = function (provider) {
    return function (exp) {
        return function (variantId) {
            if (provider.config.onExposure instanceof Data_Maybe.Just) {
                return provider.config.onExposure.value0("experiment:" + exp.name)(new StringValue(variantId));
            };
            if (provider.config.onExposure instanceof Data_Maybe.Nothing) {
                return pure(Data_Unit.unit);
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 310, column 3 - line 312, column 25): " + [ provider.config.onExposure.constructor.name ]);
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════
// Dynamic Updates
// ═══════════════════════════════════════════════════════════════════════════
// | Subscribe to flag changes
var subscribe = function (provider) {
    return function (handler) {
        return function __do() {
            Effect_Ref.modify_(Data_Function.flip(Data_Array.snoc)(handler))(provider.subscribers)();
            return Effect_Ref.modify_(Data_Array.filter(function (h) {
                return !$foreign.unsafeRefEq(h)(handler);
            }))(provider.subscribers);
        };
    };
};
var showFlagValue = {
    show: function (v) {
        if (v instanceof BoolValue) {
            return "BoolValue(" + (show(v.value0) + ")");
        };
        if (v instanceof StringValue) {
            return "StringValue(" + (v.value0 + ")");
        };
        if (v instanceof NumberValue) {
            return "NumberValue(" + (show1(v.value0) + ")");
        };
        if (v instanceof JsonValue) {
            return "JsonValue(...)";
        };
        throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 139, column 10 - line 143, column 36): " + [ v.constructor.name ]);
    }
};
var showFlag = {
    show: function (v) {
        return "Flag(" + (v + ")");
    }
};

// | Refresh flags from remote source
var refresh = function (provider) {
    return pure1(Data_Unit.unit);
};

// | Create a percentage-based targeting rule
var percentage = function (pct) {
    return function (value) {
        return {
            condition: new Percentage(pct),
            value: value
        };
    };
};

// | Notify subscribers of a flag change
var notifySubscribers = function (provider) {
    return function (f) {
        return function (value) {
            var for_ = function (arr) {
                return function (fn) {
                    return $$void($foreign.traverseImpl(fn)(arr));
                };
            };
            return function __do() {
                var subs = Effect_Ref.read(provider.subscribers)();
                return for_(subs)(function (handler) {
                    return handler(f)(value);
                })();
            };
        };
    };
};

// | Never match
var never = function (value) {
    return {
        condition: Never.value,
        value: value
    };
};

// | Track flag exposure if configured
var maybeTrackExposure = function (provider) {
    return function (f) {
        return function (val) {
            return when(provider.config.trackExposures)((function () {
                if (provider.config.onExposure instanceof Data_Maybe.Just) {
                    return provider.config.onExposure.value0(f)(val);
                };
                if (provider.config.onExposure instanceof Data_Maybe.Nothing) {
                    return pure(Data_Unit.unit);
                };
                throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 250, column 5 - line 252, column 27): " + [ provider.config.onExposure.constructor.name ]);
            })());
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════
// Persistence
// ═══════════════════════════════════════════════════════════════════════════
// | Load flags from JSON string
var loadFromJson = function (provider) {
    return function (json) {
        return function __do() {
            var definitions = $foreign.parseJsonFlags(json)();
            return Effect_Ref.write(definitions)(provider.definitions)();
        };
    };
};

// | Load flags from a URL
var loadFromUrl = function (provider) {
    return function (url) {
        return bind1($foreign.fetchJson(url))(function (json) {
            return liftEffect(loadFromJson(provider)(json));
        });
    };
};

// | Get all registered flags
var getAllFlags = function (provider) {
    return function __do() {
        var defs = Effect_Ref.read(provider.definitions)();
        return fromFoldable(Data_Map.keys(defs));
    };
};

// | Create a flag with a default value
var flagWithDefault = function (name) {
    return function (defaultVal) {
        return {
            flag: name,
            defaultValue: new BoolValue(defaultVal),
            rules: [  ],
            metadata: {
                description: Data_Maybe.Nothing.value,
                tags: [  ]
            }
        };
    };
};

// | Create a flag reference
var flag = Flag;

// | Create an experiment with equal-weight variants
var experiment = function (name) {
    return function (variantIds) {
        var weight = 100.0 / $foreign.toNumber(Data_Array.length(variantIds));
        var variants = map(function (id) {
            return {
                id: id,
                weight: weight
            };
        })(variantIds);
        return {
            name: name,
            variants: variants
        };
    };
};
var evaluateCondition = function (condition) {
    return function (ctx) {
        if (condition instanceof Always) {
            return true;
        };
        if (condition instanceof Never) {
            return false;
        };
        if (condition instanceof Percentage) {
            if (ctx.userId instanceof Data_Maybe.Just) {
                return $foreign.toNumber(mod($foreign.hashString(ctx.userId.value0))(100)) < condition.value0;
            };
            if (ctx.userId instanceof Data_Maybe.Nothing) {
                return false;
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 407, column 5 - line 409, column 23): " + [ ctx.userId.constructor.name ]);
        };
        if (condition instanceof UserIds) {
            if (ctx.userId instanceof Data_Maybe.Just) {
                return elem(ctx.userId.value0)(condition.value0);
            };
            if (ctx.userId instanceof Data_Maybe.Nothing) {
                return false;
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 412, column 5 - line 414, column 23): " + [ ctx.userId.constructor.name ]);
        };
        if (condition instanceof UserAttribute) {
            var v = lookup(condition.value0)(ctx.attributes);
            if (v instanceof Data_Maybe.Just) {
                return condition.value1(v.value0);
            };
            if (v instanceof Data_Maybe.Nothing) {
                return false;
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 417, column 5 - line 419, column 23): " + [ v.constructor.name ]);
        };
        if (condition instanceof Environment) {
            return ctx.environment === condition.value0;
        };
        if (condition instanceof AllOf) {
            return Data_Array.all(function (c) {
                return evaluateCondition(c)(ctx);
            })(condition.value0);
        };
        if (condition instanceof AnyOf) {
            return Data_Array.any(function (c) {
                return evaluateCondition(c)(ctx);
            })(condition.value0);
        };
        throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 402, column 35 - line 425, column 75): " + [ condition.constructor.name ]);
    };
};

// | Evaluate a targeting condition
var evaluateRule = function (rule) {
    return function (ctx) {
        return evaluateCondition(rule.condition)(ctx);
    };
};

// | Find the first matching targeting rule
var findMatchingRule = function (rules) {
    return function (ctx) {
        return map1(function (v) {
            return v.value;
        })(Data_Array.head(Data_Array.filter(function (r) {
            return evaluateRule(r)(ctx);
        })(rules)));
    };
};

// | Evaluate a flag against targeting rules
var evaluateFlag = function (def) {
    return function (ctx) {
        var v = findMatchingRule(def.rules)(ctx);
        if (v instanceof Data_Maybe.Just) {
            return v.value0;
        };
        if (v instanceof Data_Maybe.Nothing) {
            return def.defaultValue;
        };
        throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 257, column 3 - line 259, column 32): " + [ v.constructor.name ]);
    };
};
var eqFlagValue = {
    eq: function (x) {
        return function (y) {
            if (x instanceof BoolValue && y instanceof BoolValue) {
                return x.value0 === y.value0;
            };
            if (x instanceof StringValue && y instanceof StringValue) {
                return x.value0 === y.value0;
            };
            if (x instanceof NumberValue && y instanceof NumberValue) {
                return x.value0 === y.value0;
            };
            if (x instanceof JsonValue && y instanceof JsonValue) {
                return Data_Eq.eq(Foreign_Object.eqObject(eqFlagValue))(x.value0)(y.value0);
            };
            return false;
        };
    }
};
var eqFlag = {
    eq: function (x) {
        return function (y) {
            return x === y;
        };
    }
};
var ordFlag = {
    compare: function (x) {
        return function (y) {
            return compare(x)(y);
        };
    },
    Eq0: function () {
        return eqFlag;
    }
};
var lookup1 = /* #__PURE__ */ Data_Map_Internal.lookup(ordFlag);
var member = /* #__PURE__ */ Data_Map_Internal.member(ordFlag);
var insert = /* #__PURE__ */ Data_Map_Internal.insert(ordFlag);
var fromFoldable1 = /* #__PURE__ */ Data_Map_Internal.fromFoldable(ordFlag)(Data_Foldable.foldableArray);
var $$delete = /* #__PURE__ */ Data_Map_Internal["delete"](ordFlag);

// | Get a flag's value
var getValue = function (provider) {
    return function (f) {
        return function __do() {
            var overrides = Effect_Ref.read(provider.overrides)();
            var v = lookup1(f)(overrides);
            if (v instanceof Data_Maybe.Just) {
                maybeTrackExposure(provider)(f)(v.value0)();
                return new Data_Maybe.Just(v.value0);
            };
            if (v instanceof Data_Maybe.Nothing) {
                var definitions = Effect_Ref.read(provider.definitions)();
                var ctx = Effect_Ref.read(provider.context)();
                var v1 = lookup1(f)(definitions);
                if (v1 instanceof Data_Maybe.Just) {
                    var val = evaluateFlag(v1.value0)(ctx);
                    maybeTrackExposure(provider)(f)(val)();
                    return new Data_Maybe.Just(val);
                };
                if (v1 instanceof Data_Maybe.Nothing) {
                    return Data_Maybe.Nothing.value;
                };
                throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 231, column 7 - line 236, column 32): " + [ v1.constructor.name ]);
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 223, column 3 - line 236, column 32): " + [ v.constructor.name ]);
        };
    };
};

// | Get detailed state for a flag
var getFlagState = function (provider) {
    return function (f) {
        return function __do() {
            var definitions = Effect_Ref.read(provider.definitions)();
            var overrides = Effect_Ref.read(provider.overrides)();
            var ctx = Effect_Ref.read(provider.context)();
            var v = lookup1(f)(definitions);
            if (v instanceof Data_Maybe.Nothing) {
                return Data_Maybe.Nothing.value;
            };
            if (v instanceof Data_Maybe.Just) {
                var currentValue = getValue(provider)(f)();
                var hasOverride = member(f)(overrides);
                var matchingRules = Data_Array.filter(function (r) {
                    return evaluateRule(r)(ctx);
                })(v.value0.rules);
                return new Data_Maybe.Just({
                    flag: f,
                    currentValue: currentValue,
                    defaultValue: v.value0.defaultValue,
                    hasOverride: hasOverride,
                    matchingRules: matchingRules
                });
            };
            throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 572, column 3 - line 584, column 10): " + [ v.constructor.name ]);
        };
    };
};

// | Get a flag's value with a default
var getValueOr = function (provider) {
    return function (f) {
        return function (defaultVal) {
            return function (extract) {
                return function __do() {
                    var maybeValue = getValue(provider)(f)();
                    var v = bind2(maybeValue)(extract);
                    if (v instanceof Data_Maybe.Just) {
                        return v.value0;
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return defaultVal;
                    };
                    throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 242, column 10 - line 244, column 26): " + [ v.constructor.name ]);
                };
            };
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════
// Flag Operations
// ═══════════════════════════════════════════════════════════════════════════
// | Check if a flag is enabled (boolean flags)
var isEnabled = function (provider) {
    return function (f) {
        return function __do() {
            var value = getValue(provider)(f)();
            if (value instanceof Data_Maybe.Just && value.value0 instanceof BoolValue) {
                return value.value0.value0;
            };
            return false;
        };
    };
};

// | Check if a flag is disabled
var isDisabled = function (provider) {
    return function (f) {
        return map2(not)(isEnabled(provider)(f));
    };
};

// | Set a local override for a flag
var setOverride = function (provider) {
    return function (f) {
        return function (value) {
            return function __do() {
                Effect_Ref.modify_(insert(f)(value))(provider.overrides)();
                notifySubscribers(provider)(f)(value)();
                return when(provider.config.persistOverrides)($foreign.persistOverrides(provider.overrides))();
            };
        };
    };
};

// | Create an environment targeting rule
var environment = function (env) {
    return function (value) {
        return {
            condition: new Environment(env),
            value: value
        };
    };
};

// | Empty targeting context
var emptyContext = /* #__PURE__ */ (function () {
    return {
        userId: Data_Maybe.Nothing.value,
        attributes: Data_Map_Internal.empty,
        environment: "development"
    };
})();

// | Define a string flag
var defineStringFlag = function (name) {
    return function (defaultVal) {
        return function (rules) {
            return {
                flag: name,
                defaultValue: new StringValue(defaultVal),
                rules: rules,
                metadata: {
                    description: Data_Maybe.Nothing.value,
                    tags: [  ]
                }
            };
        };
    };
};

// | Define a number flag
var defineNumberFlag = function (name) {
    return function (defaultVal) {
        return function (rules) {
            return {
                flag: name,
                defaultValue: new NumberValue(defaultVal),
                rules: rules,
                metadata: {
                    description: Data_Maybe.Nothing.value,
                    tags: [  ]
                }
            };
        };
    };
};

// | Define a JSON flag
var defineJsonFlag = function (name) {
    return function (defaultVal) {
        return function (rules) {
            return {
                flag: name,
                defaultValue: new JsonValue(defaultVal),
                rules: rules,
                metadata: {
                    description: Data_Maybe.Nothing.value,
                    tags: [  ]
                }
            };
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════
// Flag Definitions Helpers
// ═══════════════════════════════════════════════════════════════════════════
// | Define a boolean flag
var defineBoolFlag = function (name) {
    return function (defaultVal) {
        return function (rules) {
            return {
                flag: name,
                defaultValue: new BoolValue(defaultVal),
                rules: rules,
                metadata: {
                    description: Data_Maybe.Nothing.value,
                    tags: [  ]
                }
            };
        };
    };
};

// | Default provider configuration
var defaultConfig = /* #__PURE__ */ (function () {
    return {
        persistOverrides: true,
        refreshInterval: Data_Maybe.Nothing.value,
        trackExposures: false,
        onExposure: Data_Maybe.Nothing.value
    };
})();

// | Create a flag provider with custom config
var createProviderWithConfig = function (defs) {
    return function (config) {
        var defMap = fromFoldable1(map(function (d) {
            return new Data_Tuple.Tuple(d.flag, d);
        })(defs));
        return function __do() {
            var definitions = Effect_Ref["new"](defMap)();
            var overrides = Effect_Ref["new"](Data_Map_Internal.empty)();
            var context = Effect_Ref["new"](emptyContext)();
            var subscribers = Effect_Ref["new"]([  ])();
            when(config.persistOverrides)($foreign.loadPersistedOverrides(overrides))();
            return {
                definitions: definitions,
                overrides: overrides,
                context: context,
                subscribers: subscribers,
                config: config
            };
        };
    };
};

// | Create a flag provider with default config
var createProvider = function (defs) {
    return createProviderWithConfig(defs)(defaultConfig);
};

// | Clear an override
var clearOverride = function (provider) {
    return function (f) {
        return function __do() {
            Effect_Ref.modify_($$delete(f))(provider.overrides)();
            var maybeVal = getValue(provider)(f)();
            (function () {
                if (maybeVal instanceof Data_Maybe.Just) {
                    return notifySubscribers(provider)(f)(maybeVal.value0)();
                };
                if (maybeVal instanceof Data_Maybe.Nothing) {
                    return Data_Unit.unit;
                };
                throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 496, column 3 - line 498, column 25): " + [ maybeVal.constructor.name ]);
            })();
            return when(provider.config.persistOverrides)($foreign.persistOverrides(provider.overrides))();
        };
    };
};

// | Clear all overrides
var clearAllOverrides = function (provider) {
    return function __do() {
        Effect_Ref.write(Data_Map_Internal.empty)(provider.overrides)();
        return when(provider.config.persistOverrides)($foreign.persistOverrides(provider.overrides))();
    };
};

// | Assign a variant based on hash
var assignVariant = function (variants) {
    return function (hash) {
        var normalized = $foreign.toNumber(mod(hash)(100));
        var go = function ($copy_acc) {
            return function ($copy_arr) {
                var $tco_var_acc = $copy_acc;
                var $tco_done = false;
                var $tco_result;
                function $tco_loop(acc, arr) {
                    var v = Data_Array.uncons(arr);
                    if (v instanceof Data_Maybe.Nothing) {
                        $tco_done = true;
                        return Data_Maybe.Nothing.value;
                    };
                    if (v instanceof Data_Maybe.Just) {
                        var $119 = normalized < acc + v.value0.head.weight;
                        if ($119) {
                            $tco_done = true;
                            return new Data_Maybe.Just(v.value0.head.id);
                        };
                        $tco_var_acc = acc + v.value0.head.weight;
                        $copy_arr = v.value0.tail;
                        return;
                    };
                    throw new Error("Failed pattern match at Hydrogen.Feature.Flags (line 320, column 18 - line 325, column 38): " + [ v.constructor.name ]);
                };
                while (!$tco_done) {
                    $tco_result = $tco_loop($tco_var_acc, $copy_arr);
                };
                return $tco_result;
            };
        };
        return go(0.0)(variants);
    };
};

// | Get the assigned variant for an experiment
var getVariant = function (provider) {
    return function (exp) {
        return function __do() {
            var ctx = Effect_Ref.read(provider.context)();
            var hash = $foreign.hashString(exp.name + Data_Maybe.fromMaybe("")(ctx.userId));
            return assignVariant(exp.variants)(hash);
        };
    };
};

// | Get the variant index (0-based)
var getVariantIndex = function (provider) {
    return function (exp) {
        return function __do() {
            var variant = getVariant(provider)(exp)();
            return bind2(variant)(function (v) {
                return Data_Array.findIndex(function ($$var) {
                    return $$var.id === v;
                })(exp.variants);
            });
        };
    };
};

// | Any condition must match
var anyOf = function (conditions) {
    return function (value) {
        return {
            condition: new AnyOf(conditions),
            value: value
        };
    };
};

// | Always match (useful for default overrides)
var always = function (value) {
    return {
        condition: Always.value,
        value: value
    };
};

// | All conditions must match
var allOf = function (conditions) {
    return function (value) {
        return {
            condition: new AllOf(conditions),
            value: value
        };
    };
};
export {
    flag,
    flagWithDefault,
    createProvider,
    createProviderWithConfig,
    isEnabled,
    isDisabled,
    getValue,
    getValueOr,
    experiment,
    getVariant,
    getVariantIndex,
    trackExposure,
    Percentage,
    UserIds,
    UserAttribute,
    Environment,
    Always,
    Never,
    AllOf,
    AnyOf,
    percentage,
    userIds,
    userAttribute,
    environment,
    always,
    never,
    allOf,
    anyOf,
    BoolValue,
    StringValue,
    NumberValue,
    JsonValue,
    defineBoolFlag,
    defineStringFlag,
    defineNumberFlag,
    defineJsonFlag,
    subscribe,
    refresh,
    setOverride,
    clearOverride,
    clearAllOverrides,
    loadFromJson,
    loadFromUrl,
    getAllFlags,
    getFlagState,
    eqFlag,
    ordFlag,
    showFlag,
    eqFlagValue,
    showFlagValue
};
