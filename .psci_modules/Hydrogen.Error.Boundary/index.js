// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//                                                       // hydrogen // boundary
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// | Error boundaries and recovery patterns
// |
// | Structured error handling with fallbacks, retries, and recovery.
// |
// | ## Usage
// |
// | ```purescript
// | import Hydrogen.Error.Boundary as Boundary
// |
// | -- Wrap content with fallback
// | Boundary.withFallback
// |   { fallback: \err -> errorCard err
// |   , onError: \err -> logError err
// |   }
// |   content
// |
// | -- With retry
// | Boundary.withRetry
// |   { maxRetries: 3
// |   , delay: Milliseconds 1000.0
// |   , onRetry: \attempt -> showRetrying attempt
// |   }
// |   fetchData
// |
// | -- Graceful degradation
// | Boundary.degrade
// |   [ fullFeature, reducedFeature, minimalFeature ]
// | ```
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Exception from "../Effect.Exception/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var throwError = /* #__PURE__ */ Control_Monad_Error_Class.throwError(Effect_Aff.monadThrowAff);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);

// | Recovery strategy
var Fallback = /* #__PURE__ */ (function () {
    function Fallback(value0) {
        this.value0 = value0;
    };
    Fallback.create = function (value0) {
        return new Fallback(value0);
    };
    return Fallback;
})();

// | Recovery strategy
var Retry = /* #__PURE__ */ (function () {
    function Retry(value0) {
        this.value0 = value0;
    };
    Retry.create = function (value0) {
        return new Retry(value0);
    };
    return Retry;
})();

// | Recovery strategy
var Ignore = /* #__PURE__ */ (function () {
    function Ignore() {

    };
    Ignore.value = new Ignore();
    return Ignore;
})();

// | Recovery strategy
var Propagate = /* #__PURE__ */ (function () {
    function Propagate() {

    };
    Propagate.value = new Propagate();
    return Propagate;
})();

// | Execute with retry logic
var withRetry = function (config) {
    return function (action) {
        var go = function (attempt1) {
            return bind(Effect_Aff.attempt(action))(function (result) {
                if (result instanceof Data_Either.Right) {
                    return pure(result.value0);
                };
                if (result instanceof Data_Either.Left) {
                    var $25 = attempt1 < config.maxRetries && config.shouldRetry(result.value0);
                    if ($25) {
                        return discard1(liftEffect(config.onRetry(attempt1 + 1 | 0)))(function () {
                            return discard1(Effect_Aff.delay(config.delay))(function () {
                                return go(attempt1 + 1 | 0);
                            });
                        });
                    };
                    return throwError(result.value0);
                };
                throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 176, column 5 - line 184, column 30): " + [ result.constructor.name ]);
            });
        };
        return go(0);
    };
};

// | Pure version with Maybe
var withFallbackPure = function (fallback) {
    return Data_Maybe.fromMaybe(fallback);
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                             // error boundaries
// ═══════════════════════════════════════════════════════════════════════════════
// | Wrap content with a fallback UI for errors
var withFallback = function (config) {
    return function (content) {
        return function __do() {
            var result = Effect_Exception["try"](content)();
            if (result instanceof Data_Either.Right) {
                return result.value0;
            };
            if (result instanceof Data_Either.Left) {
                config.onError(result.value0)();
                return config.fallback(result.value0);
            };
            throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 131, column 3 - line 135, column 33): " + [ result.constructor.name ]);
        };
    };
};

// | Retry with exponential backoff
var withExponentialBackoff = function (maxRetries) {
    return function (baseDelay) {
        return function (action) {
            var toNumber = function (n) {
                var $30 = n <= 0;
                if ($30) {
                    return 0.0;
                };
                return 1.0 + toNumber(n - 1 | 0);
            };
            var pow = function (base) {
                return function (exp) {
                    var $31 = exp <= 0.0;
                    if ($31) {
                        return 1.0;
                    };
                    return base * pow(base)(exp - 1.0);
                };
            };
            var go = function (attempt1) {
                return bind(Effect_Aff.attempt(action))(function (result) {
                    if (result instanceof Data_Either.Right) {
                        return pure(result.value0);
                    };
                    if (result instanceof Data_Either.Left) {
                        var $34 = attempt1 < maxRetries;
                        if ($34) {
                            var backoffMs = baseDelay * pow(2.0)(toNumber(attempt1));
                            return discard1(Effect_Aff.delay(backoffMs))(function () {
                                return go(attempt1 + 1 | 0);
                            });
                        };
                        return throwError(result.value0);
                    };
                    throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 192, column 5 - line 201, column 30): " + [ result.constructor.name ]);
                });
            };
            return go(0);
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                   // utilities
// ═══════════════════════════════════════════════════════════════════════════════
// | Safely execute an effect, returning Maybe
var safely = function (action) {
    return function __do() {
        var result = Effect_Exception["try"](action)();
        if (result instanceof Data_Either.Right) {
            return new Data_Maybe.Just(result.value0);
        };
        if (result instanceof Data_Either.Left) {
            return Data_Maybe.Nothing.value;
        };
        throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 293, column 10 - line 295, column 22): " + [ result.constructor.name ]);
    };
};

// | Safely execute with a default value
var safelyWithDefault = function (def) {
    return function (action) {
        return function __do() {
            var result = safely(action)();
            return Data_Maybe.fromMaybe(def)(result);
        };
    };
};

// | Retry until a condition is met
var retryUntil = function (predicate) {
    return function (maxAttempts) {
        return function (action) {
            var go = function (attempt1) {
                return bind(action)(function (result) {
                    var $40 = predicate(result);
                    if ($40) {
                        return pure(result);
                    };
                    var $41 = attempt1 < maxAttempts;
                    if ($41) {
                        return go(attempt1 + 1 | 0);
                    };
                    return pure(result);
                });
            };
            return go(0);
        };
    };
};

// | Recover from an error with a handler
var recover = function (action) {
    return function (handler) {
        return bind(Effect_Aff.attempt(action))(function (result) {
            if (result instanceof Data_Either.Right) {
                return pure(result.value0);
            };
            if (result instanceof Data_Either.Left) {
                return handler(result.value0);
            };
            throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 241, column 3 - line 243, column 28): " + [ result.constructor.name ]);
        });
    };
};

// | Apply recovery strategy
var withRecovery = function (strategy) {
    return function (action) {
        if (strategy instanceof Fallback) {
            return recover(action)(function (v) {
                return pure(strategy.value0);
            });
        };
        if (strategy instanceof Retry) {
            return withRetry(strategy.value0)(action);
        };
        if (strategy instanceof Ignore) {
            return recover(action)(function (v) {
                return action;
            });
        };
        if (strategy instanceof Propagate) {
            return action;
        };
        throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 247, column 32 - line 251, column 22): " + [ strategy.constructor.name ]);
    };
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                    // recovery
// ═══════════════════════════════════════════════════════════════════════════════
// | Graceful degradation - try alternatives in order
var degrade = function (alternatives) {
    var go = function (arr) {
        var v = Data_Array.uncons(arr);
        if (v instanceof Data_Maybe.Nothing) {
            return pure(Data_Maybe.Nothing.value);
        };
        if (v instanceof Data_Maybe.Just) {
            return bind(Effect_Aff.attempt(v.value0.head))(function (result) {
                if (result instanceof Data_Either.Right) {
                    return pure(new Data_Maybe.Just(result.value0));
                };
                if (result instanceof Data_Either.Left) {
                    return go(v.value0.tail);
                };
                throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 233, column 7 - line 235, column 26): " + [ result.constructor.name ]);
            });
        };
        throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 229, column 12 - line 235, column 26): " + [ v.constructor.name ]);
    };
    return go(alternatives);
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                  // retry logic
// ═══════════════════════════════════════════════════════════════════════════════
// | Default retry configuration
var defaultRetryConfig = {
    maxRetries: 3,
    delay: 1000.0,
    shouldRetry: function (v) {
        return true;
    },
    onRetry: function (v) {
        return pure1(Data_Unit.unit);
    }
};

// | Create an error report
var createErrorReport = function (err) {
    return function (context) {
        return function __do() {
            var timestamp = $foreign.getTimestamp();
            var userAgent = $foreign.getUserAgent();
            var url = $foreign.getUrl();
            return {
                error: Effect_Exception.message(err),
                stack: $foreign.getStack(err),
                timestamp: timestamp,
                context: context,
                userAgent: userAgent,
                url: url
            };
        };
    };
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                             // error reporting
// ═══════════════════════════════════════════════════════════════════════════════
// | Report an error (to console, monitoring service, etc.)
var reportError = function (err) {
    return function __do() {
        var report = createErrorReport(err)(Data_Maybe.Nothing.value)();
        return $foreign.reportErrorImpl(report)();
    };
};

// | Catch errors in an effect
var catchError = function (action) {
    return function (handler) {
        return function __do() {
            var result = Effect_Exception["try"](action)();
            if (result instanceof Data_Either.Right) {
                return result.value0;
            };
            if (result instanceof Data_Either.Left) {
                return handler(result.value0)();
            };
            throw new Error("Failed pattern match at Hydrogen.Error.Boundary (line 153, column 3 - line 155, column 28): " + [ result.constructor.name ]);
        };
    };
};

// | Attempt an effect, returning Either
var attempt = Effect_Exception["try"];
export {
    Fallback,
    Retry,
    Ignore,
    Propagate,
    withFallback,
    withFallbackPure,
    catchError,
    withRetry,
    withExponentialBackoff,
    retryUntil,
    degrade,
    recover,
    withRecovery,
    reportError,
    createErrorReport,
    safely,
    safelyWithDefault,
    attempt
};
