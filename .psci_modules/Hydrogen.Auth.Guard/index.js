// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//                                                          // hydrogen // guard
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// | Route guards for protected routes
// |
// | Type-safe route protection with role-based access control.
// |
// | ## Usage
// |
// | ```purescript
// | import Hydrogen.Auth.Guard as Guard
// |
// | -- Simple auth guard
// | Guard.requireAuth session do
// |   renderProtectedPage
// |
// | -- Role-based guard
// | Guard.requireRole session "admin" do
// |   renderAdminPage
// |
// | -- Permission-based guard
// | Guard.requirePermission session "users:write" do
// |   renderUserEditor
// |
// | -- With fallback
// | Guard.withAuth session
// |   { authenticated: renderDashboard
// |   , unauthenticated: renderLogin
// |   }
// | ```
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Category from "../Control.Category/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Effect from "../Effect/index.js";
import * as Halogen_HTML_Core from "../Halogen.HTML.Core/index.js";
import * as Hydrogen_Auth_Session from "../Hydrogen.Auth.Session/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var identity = /* #__PURE__ */ Control_Category.identity(Control_Category.categoryFn);
var elem = /* #__PURE__ */ Data_Array.elem(Data_Eq.eqString);

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                       // types
// ═══════════════════════════════════════════════════════════════════════════════
// | Result of a guard check
var Allowed = /* #__PURE__ */ (function () {
    function Allowed() {

    };
    Allowed.value = new Allowed();
    return Allowed;
})();

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                       // types
// ═══════════════════════════════════════════════════════════════════════════════
// | Result of a guard check
var NotAuthenticated = /* #__PURE__ */ (function () {
    function NotAuthenticated() {

    };
    NotAuthenticated.value = new NotAuthenticated();
    return NotAuthenticated;
})();

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                       // types
// ═══════════════════════════════════════════════════════════════════════════════
// | Result of a guard check
var NotAuthorized = /* #__PURE__ */ (function () {
    function NotAuthorized(value0) {
        this.value0 = value0;
    };
    NotAuthorized.create = function (value0) {
        return new NotAuthorized(value0);
    };
    return NotAuthorized;
})();

// ═══════════════════════════════════════════════════════════════════════════════
//                                                        // conditional rendering
// ═══════════════════════════════════════════════════════════════════════════════
// | Render different content based on auth state
var withAuth = function (session) {
    return function (v) {
        return function __do() {
            var authState = Hydrogen_Auth_Session.getAuthState(session)();
            if (authState instanceof Hydrogen_Auth_Session.Authenticated) {
                return v.authenticated;
            };
            return v.unauthenticated;
        };
    };
};

// | Render content only when authenticated
var whenAuthenticated = function (session) {
    return function (content) {
        return function __do() {
            var authState = Hydrogen_Auth_Session.getAuthState(session)();
            if (authState instanceof Hydrogen_Auth_Session.Authenticated) {
                return content;
            };
            return Halogen_HTML_Core.text("");
        };
    };
};

// | Render content only when NOT authenticated
var unlessAuthenticated = function (session) {
    return function (content) {
        return function __do() {
            var authState = Hydrogen_Auth_Session.getAuthState(session)();
            if (authState instanceof Hydrogen_Auth_Session.Authenticated) {
                return Halogen_HTML_Core.text("");
            };
            return content;
        };
    };
};
var showGuardResult = {
    show: function (v) {
        if (v instanceof Allowed) {
            return "Allowed";
        };
        if (v instanceof NotAuthenticated) {
            return "NotAuthenticated";
        };
        if (v instanceof NotAuthorized) {
            return "NotAuthorized: " + v.value0;
        };
        throw new Error("Failed pattern match at Hydrogen.Auth.Guard (line 73, column 1 - line 76, column 60): " + [ v.constructor.name ]);
    }
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                      // guards
// ═══════════════════════════════════════════════════════════════════════════════
// | Require authentication
var requireAuth = function (session) {
    return function ($$protected) {
        return function (fallback) {
            return function __do() {
                var authState = Hydrogen_Auth_Session.getAuthState(session)();
                if (authState instanceof Hydrogen_Auth_Session.Authenticated) {
                    return $$protected;
                };
                return fallback;
            };
        };
    };
};

// | Require any of multiple conditions
var requireAny = function (conditions) {
    return function ($$protected) {
        return function (fallback) {
            var traverse = function (f) {
                return function (arr) {
                    var v = Data_Array.uncons(arr);
                    if (v instanceof Data_Maybe.Nothing) {
                        return pure([  ]);
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return function __do() {
                            var b = f(v.value0.head)();
                            var bs = traverse(f)(v.value0.tail)();
                            return append1([ b ])(bs);
                        };
                    };
                    throw new Error("Failed pattern match at Hydrogen.Auth.Guard (line 198, column 20 - line 203, column 23): " + [ v.constructor.name ]);
                };
            };
            var sequence = traverse(identity);
            return function __do() {
                var results = sequence(conditions)();
                var $37 = Data_Array.any(identity)(results);
                if ($37) {
                    return $$protected;
                };
                return fallback;
            };
        };
    };
};

// | Require all conditions
var requireAll = function (conditions) {
    return function ($$protected) {
        return function (fallback) {
            var traverse = function (f) {
                return function (arr) {
                    var v = Data_Array.uncons(arr);
                    if (v instanceof Data_Maybe.Nothing) {
                        return pure([  ]);
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return function __do() {
                            var b = f(v.value0.head)();
                            var bs = traverse(f)(v.value0.tail)();
                            return append1([ b ])(bs);
                        };
                    };
                    throw new Error("Failed pattern match at Hydrogen.Auth.Guard (line 222, column 20 - line 227, column 23): " + [ v.constructor.name ]);
                };
            };
            var sequence = traverse(identity);
            return function __do() {
                var results = sequence(conditions)();
                var $42 = Data_Array.all(identity)(results);
                if ($42) {
                    return $$protected;
                };
                return fallback;
            };
        };
    };
};
var getRoles = function (dict) {
    return dict.getRoles;
};

// | Require a specific role
var requireRole = function (dictHasRole) {
    var getRoles1 = getRoles(dictHasRole);
    return function (session) {
        return function (role) {
            return function ($$protected) {
                return function (fallback) {
                    return function __do() {
                        var authState = Hydrogen_Auth_Session.getAuthState(session)();
                        var maybeUser = Hydrogen_Auth_Session.getUser(session)();
                        if (authState instanceof Hydrogen_Auth_Session.Authenticated && maybeUser instanceof Data_Maybe.Just) {
                            var $46 = elem(role)(getRoles1(maybeUser.value0));
                            if ($46) {
                                return $$protected;
                            };
                            return fallback;
                        };
                        return fallback;
                    };
                };
            };
        };
    };
};

// | Require any of multiple roles
var requireRoles = function (dictHasRole) {
    var getRoles1 = getRoles(dictHasRole);
    return function (session) {
        return function (roles) {
            return function ($$protected) {
                return function (fallback) {
                    return function __do() {
                        var authState = Hydrogen_Auth_Session.getAuthState(session)();
                        var maybeUser = Hydrogen_Auth_Session.getUser(session)();
                        if (authState instanceof Hydrogen_Auth_Session.Authenticated && maybeUser instanceof Data_Maybe.Just) {
                            var userRoles = getRoles1(maybeUser.value0);
                            var $50 = Data_Array.any(function (r) {
                                return elem(r)(userRoles);
                            })(roles);
                            if ($50) {
                                return $$protected;
                            };
                            return fallback;
                        };
                        return fallback;
                    };
                };
            };
        };
    };
};
var getPermissions = function (dict) {
    return dict.getPermissions;
};

// | Require a specific permission
var requirePermission = function (dictHasPermission) {
    var getPermissions1 = getPermissions(dictHasPermission);
    return function (session) {
        return function (permission) {
            return function ($$protected) {
                return function (fallback) {
                    return function __do() {
                        var authState = Hydrogen_Auth_Session.getAuthState(session)();
                        var maybeUser = Hydrogen_Auth_Session.getUser(session)();
                        if (authState instanceof Hydrogen_Auth_Session.Authenticated && maybeUser instanceof Data_Maybe.Just) {
                            var $55 = elem(permission)(getPermissions1(maybeUser.value0));
                            if ($55) {
                                return $$protected;
                            };
                            return fallback;
                        };
                        return fallback;
                    };
                };
            };
        };
    };
};

// | Require multiple permissions
var requirePermissions = function (dictHasPermission) {
    var getPermissions1 = getPermissions(dictHasPermission);
    return function (session) {
        return function (permissions) {
            return function ($$protected) {
                return function (fallback) {
                    return function __do() {
                        var authState = Hydrogen_Auth_Session.getAuthState(session)();
                        var maybeUser = Hydrogen_Auth_Session.getUser(session)();
                        if (authState instanceof Hydrogen_Auth_Session.Authenticated && maybeUser instanceof Data_Maybe.Just) {
                            var userPerms = getPermissions1(maybeUser.value0);
                            var $59 = Data_Array.all(function (p) {
                                return elem(p)(userPerms);
                            })(permissions);
                            if ($59) {
                                return $$protected;
                            };
                            return fallback;
                        };
                        return fallback;
                    };
                };
            };
        };
    };
};
var eqGuardResult = {
    eq: function (x) {
        return function (y) {
            if (x instanceof Allowed && y instanceof Allowed) {
                return true;
            };
            if (x instanceof NotAuthenticated && y instanceof NotAuthenticated) {
                return true;
            };
            if (x instanceof NotAuthorized && y instanceof NotAuthorized) {
                return x.value0 === y.value0;
            };
            return false;
        };
    }
};
export {
    requireAuth,
    requireRole,
    requireRoles,
    requirePermission,
    requirePermissions,
    requireAny,
    requireAll,
    withAuth,
    whenAuthenticated,
    unlessAuthenticated,
    Allowed,
    NotAuthenticated,
    NotAuthorized,
    getRoles,
    getPermissions,
    eqGuardResult,
    showGuardResult
};
