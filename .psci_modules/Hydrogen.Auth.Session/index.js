// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//                                                        // hydrogen // session
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// | Session and authentication management
// |
// | Handles user sessions, token storage, refresh, and auth state.
// |
// | ## Usage
// |
// | ```purescript
// | import Hydrogen.Auth.Session as Session
// |
// | -- Create session manager
// | session <- Session.create
// |   { storage: Session.LocalStorage
// |   , tokenKey: "auth_token"
// |   , refreshKey: "refresh_token"
// |   , onExpire: handleLogout
// |   }
// |
// | -- Login
// | Session.setTokens session { accessToken, refreshToken, expiresIn }
// |
// | -- Check auth
// | isAuthed <- Session.isAuthenticated session
// |
// | -- Get token for API calls
// | maybeToken <- Session.getAccessToken session
// |
// | -- Logout
// | Session.clear session
// | ```
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Data_Argonaut_Core from "../Data.Argonaut.Core/index.js";
import * as Data_Argonaut_Decode_Class from "../Data.Argonaut.Decode.Class/index.js";
import * as Data_Argonaut_Decode_Parser from "../Data.Argonaut.Decode.Parser/index.js";
import * as Data_Argonaut_Encode_Class from "../Data.Argonaut.Encode.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_DateTime_Instant from "../Data.DateTime.Instant/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Time_Duration from "../Data.Time.Duration/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Now from "../Effect.Now/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var traverse_ = /* #__PURE__ */ Data_Foldable.traverse_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var bind1 = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var discard2 = /* #__PURE__ */ discard(Effect_Aff.bindAff);
var liftEffect = /* #__PURE__ */ Effect_Class.liftEffect(Effect_Aff.monadEffectAff);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Effect_Aff.bindAff);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(Effect_Aff.applicativeAff);
var greaterThan = /* #__PURE__ */ Data_Ord.greaterThan(Data_Time_Duration.ordMilliseconds);

// | Storage backend
var LocalStorage = /* #__PURE__ */ (function () {
    function LocalStorage() {

    };
    LocalStorage.value = new LocalStorage();
    return LocalStorage;
})();

// | Storage backend
var SessionStorage = /* #__PURE__ */ (function () {
    function SessionStorage() {

    };
    SessionStorage.value = new SessionStorage();
    return SessionStorage;
})();

// | Storage backend
var MemoryOnly = /* #__PURE__ */ (function () {
    function MemoryOnly() {

    };
    MemoryOnly.value = new MemoryOnly();
    return MemoryOnly;
})();

// | Authentication state
var Unauthenticated = /* #__PURE__ */ (function () {
    function Unauthenticated() {

    };
    Unauthenticated.value = new Unauthenticated();
    return Unauthenticated;
})();

// | Authentication state
var Authenticating = /* #__PURE__ */ (function () {
    function Authenticating() {

    };
    Authenticating.value = new Authenticating();
    return Authenticating;
})();

// | Authentication state
var Authenticated = /* #__PURE__ */ (function () {
    function Authenticated() {

    };
    Authenticated.value = new Authenticated();
    return Authenticated;
})();

// | Authentication state
var Refreshing = /* #__PURE__ */ (function () {
    function Refreshing() {

    };
    Refreshing.value = new Refreshing();
    return Refreshing;
})();

// | Authentication state
var Expired = /* #__PURE__ */ (function () {
    function Expired() {

    };
    Expired.value = new Expired();
    return Expired;
})();

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                       // types
// ═══════════════════════════════════════════════════════════════════════════════
// | Session manager
var Session = function (x) {
    return x;
};
var toNumber = function (n) {
    var $48 = n <= 0;
    if ($48) {
        return 0.0;
    };
    return 1.0 + toNumber(n - 1 | 0);
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                     // helpers
// ═══════════════════════════════════════════════════════════════════════════════
var storageTypeToKey = function (v) {
    if (v instanceof LocalStorage) {
        return "localStorage";
    };
    if (v instanceof SessionStorage) {
        return "sessionStorage";
    };
    if (v instanceof MemoryOnly) {
        return "memory";
    };
    throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 347, column 20 - line 350, column 25): " + [ v.constructor.name ]);
};
var showAuthState = {
    show: function (v) {
        if (v instanceof Unauthenticated) {
            return "Unauthenticated";
        };
        if (v instanceof Authenticating) {
            return "Authenticating";
        };
        if (v instanceof Authenticated) {
            return "Authenticated";
        };
        if (v instanceof Refreshing) {
            return "Refreshing";
        };
        if (v instanceof Expired) {
            return "Expired";
        };
        throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 128, column 1 - line 133, column 27): " + [ v.constructor.name ]);
    }
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                   // user data
// ═══════════════════════════════════════════════════════════════════════════════
// | Set user data
var setUser = function (dictEncodeJson) {
    var encodeJson = Data_Argonaut_Encode_Class.encodeJson(dictEncodeJson);
    return function (v) {
        return function (userData) {
            return function __do() {
                Effect_Ref.write(new Data_Maybe.Just(userData))(v.user)();
                var storageKey = storageTypeToKey(v.config.storage);
                return $foreign.setStorageItem(storageKey)(v.config.userKey)(Data_Argonaut_Core.stringify(encodeJson(userData)))();
            };
        };
    };
};

// | Set auth state and notify listeners
var setAuthState = function (v) {
    return function (newState) {
        var for_ = function (arr) {
            return function (f) {
                return traverse_(f)(arr);
            };
        };
        return function __do() {
            Effect_Ref.write(newState)(v.authState)();
            var subs = Effect_Ref.read(v.listeners)();
            return for_(subs)(function (listener) {
                return listener.callback(newState);
            })();
        };
    };
};

// | Set tokens after login
var setTokens = function (v) {
    return function (tokens) {
        var storageKey = storageTypeToKey(v.config.storage);
        return function __do() {
            Effect_Ref.write(new Data_Maybe.Just(tokens.accessToken))(v.accessToken)();
            $foreign.setStorageItem(storageKey)(v.config.tokenKey)(tokens.accessToken)();
            (function () {
                if (tokens.refreshToken instanceof Data_Maybe.Nothing) {
                    return Data_Unit.unit;
                };
                if (tokens.refreshToken instanceof Data_Maybe.Just) {
                    Effect_Ref.write(new Data_Maybe.Just(tokens.refreshToken.value0))(v.refreshToken)();
                    return $foreign.setStorageItem(storageKey)(v.config.refreshKey)(tokens.refreshToken.value0)();
                };
                throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 219, column 3 - line 223, column 55): " + [ tokens.refreshToken.constructor.name ]);
            })();
            var currentTime = Effect_Now.now();
            var expiresMs = unwrap(Data_DateTime_Instant.unInstant(currentTime)) + toNumber(tokens.expiresIn) * 1000.0;
            return setAuthState(v)(Authenticated.value)();
        };
    };
};

// | Restore session from storage
var restoreFromStorage = function (dictDecodeJson) {
    var decodeJson = Data_Argonaut_Decode_Class.decodeJson(dictDecodeJson);
    return function (v) {
        var storageKey = storageTypeToKey(v.config.storage);
        return function __do() {
            var maybeToken = $foreign.getStorageItem(storageKey)(v.config.tokenKey)();
            (function () {
                if (maybeToken instanceof Data_Maybe.Nothing) {
                    return Data_Unit.unit;
                };
                if (maybeToken instanceof Data_Maybe.Just) {
                    Effect_Ref.write(new Data_Maybe.Just(maybeToken.value0))(v.accessToken)();
                    return setAuthState(v)(Authenticated.value)();
                };
                throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 193, column 3 - line 197, column 41): " + [ maybeToken.constructor.name ]);
            })();
            var maybeRefresh = $foreign.getStorageItem(storageKey)(v.config.refreshKey)();
            Effect_Ref.write(maybeRefresh)(v.refreshToken)();
            var maybeUserJson = $foreign.getStorageItem(storageKey)(v.config.userKey)();
            var v1 = bind1(bind1(maybeUserJson)(function ($95) {
                return Data_Either.hush(Data_Argonaut_Decode_Parser.parseJson($95));
            }))(function ($96) {
                return Data_Either.hush(decodeJson($96));
            });
            if (v1 instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            if (v1 instanceof Data_Maybe.Just) {
                return Effect_Ref.write(new Data_Maybe.Just(v1.value0))(v.user)();
            };
            throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 205, column 3 - line 207, column 40): " + [ v1.constructor.name ]);
        };
    };
};

// | Refresh the session (call your refresh endpoint)
var refresh = function (v) {
    return function (refreshFn) {
        return discard2(liftEffect(setAuthState(v)(Refreshing.value)))(function () {
            return bind2(liftEffect(Effect_Ref.read(v.refreshToken)))(function (maybeRefreshToken) {
                if (maybeRefreshToken instanceof Data_Maybe.Nothing) {
                    return discard2(liftEffect(setAuthState(v)(Expired.value)))(function () {
                        return discard2(liftEffect(v.config.onExpire))(function () {
                            return pure1(Data_Maybe.Nothing.value);
                        });
                    });
                };
                if (maybeRefreshToken instanceof Data_Maybe.Just) {
                    return bind2(refreshFn)(function (result) {
                        return discard2(liftEffect(setTokens(v)(result)))(function () {
                            return pure1(new Data_Maybe.Just(result));
                        });
                    });
                };
                throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 254, column 3 - line 262, column 25): " + [ maybeRefreshToken.constructor.name ]);
            });
        });
    };
};

// | Subscribe to auth state changes
var onAuthStateChange = function (v) {
    return function (callback) {
        return function __do() {
            var subs = Effect_Ref.read(v.listeners)();
            var nextId = (function () {
                var v1 = Data_Array.last(subs);
                if (v1 instanceof Data_Maybe.Nothing) {
                    return 0;
                };
                if (v1 instanceof Data_Maybe.Just) {
                    return v1.value0.id + 1 | 0;
                };
                throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 313, column 16 - line 315, column 27): " + [ v1.constructor.name ]);
            })();
            var sub1 = {
                id: nextId,
                callback: callback
            };
            Effect_Ref.modify_(Data_Function.flip(Data_Array.snoc)(sub1))(v.listeners)();
            return Effect_Ref.modify_(Data_Array.filter(function (s) {
                return s.id !== nextId;
            }))(v.listeners);
        };
    };
};

// | Check if session is expired
var isExpired = function (v) {
    return function __do() {
        var maybeExpires = Effect_Ref.read(v.expiresAt)();
        if (maybeExpires instanceof Data_Maybe.Nothing) {
            return false;
        };
        if (maybeExpires instanceof Data_Maybe.Just) {
            var currentTime = Effect_Now.now();
            return greaterThan(Data_DateTime_Instant.unInstant(currentTime))(Data_DateTime_Instant.unInstant(maybeExpires.value0));
        };
        throw new Error("Failed pattern match at Hydrogen.Auth.Session (line 286, column 3 - line 290, column 55): " + [ maybeExpires.constructor.name ]);
    };
};

// | Check if user is authenticated
var isAuthenticated = function (v) {
    return function __do() {
        var token = Effect_Ref.read(v.accessToken)();
        return Data_Maybe.isJust(token);
    };
};

// | Get user data
var getUser = function (v) {
    return Effect_Ref.read(v.user);
};

// | Get the current refresh token
var getRefreshToken = function (v) {
    return Effect_Ref.read(v.refreshToken);
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                  // auth state
// ═══════════════════════════════════════════════════════════════════════════════
// | Get current auth state
var getAuthState = function (v) {
    return Effect_Ref.read(v.authState);
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                               // token access
// ═══════════════════════════════════════════════════════════════════════════════
// | Get the current access token
var getAccessToken = function (v) {
    return Effect_Ref.read(v.accessToken);
};
var eqStorageType = {
    eq: function (x) {
        return function (y) {
            if (x instanceof LocalStorage && y instanceof LocalStorage) {
                return true;
            };
            if (x instanceof SessionStorage && y instanceof SessionStorage) {
                return true;
            };
            if (x instanceof MemoryOnly && y instanceof MemoryOnly) {
                return true;
            };
            return false;
        };
    }
};
var eqAuthState = {
    eq: function (x) {
        return function (y) {
            if (x instanceof Unauthenticated && y instanceof Unauthenticated) {
                return true;
            };
            if (x instanceof Authenticating && y instanceof Authenticating) {
                return true;
            };
            if (x instanceof Authenticated && y instanceof Authenticated) {
                return true;
            };
            if (x instanceof Refreshing && y instanceof Refreshing) {
                return true;
            };
            if (x instanceof Expired && y instanceof Expired) {
                return true;
            };
            return false;
        };
    }
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                          // session management
// ═══════════════════════════════════════════════════════════════════════════════
// | Default session configuration
var defaultConfig = /* #__PURE__ */ (function () {
    return {
        storage: LocalStorage.value,
        tokenKey: "hydrogen_access_token",
        refreshKey: "hydrogen_refresh_token",
        userKey: "hydrogen_user",
        onExpire: pure(Data_Unit.unit),
        refreshThreshold: 60000.0,
        autoRefresh: true
    };
})();

// | Create a new session manager
var create = function (dictDecodeJson) {
    var restoreFromStorage1 = restoreFromStorage(dictDecodeJson);
    return function (config) {
        return function __do() {
            var accessToken = Effect_Ref["new"](Data_Maybe.Nothing.value)();
            var refreshToken = Effect_Ref["new"](Data_Maybe.Nothing.value)();
            var expiresAt = Effect_Ref["new"](Data_Maybe.Nothing.value)();
            var user = Effect_Ref["new"](Data_Maybe.Nothing.value)();
            var authState = Effect_Ref["new"](Unauthenticated.value)();
            var listeners = Effect_Ref["new"]([  ])();
            var session = {
                config: config,
                accessToken: accessToken,
                refreshToken: refreshToken,
                expiresAt: expiresAt,
                user: user,
                authState: authState,
                listeners: listeners
            };
            restoreFromStorage1(session)();
            return session;
        };
    };
};

// | Clear user data
var clearUser = function (v) {
    return function __do() {
        Effect_Ref.write(Data_Maybe.Nothing.value)(v.user)();
        var storageKey = storageTypeToKey(v.config.storage);
        return $foreign.removeStorageItem(storageKey)(v.config.userKey)();
    };
};

// | Clear session (logout)
var clear = function (v) {
    var storageKey = storageTypeToKey(v.config.storage);
    return function __do() {
        Effect_Ref.write(Data_Maybe.Nothing.value)(v.accessToken)();
        Effect_Ref.write(Data_Maybe.Nothing.value)(v.refreshToken)();
        Effect_Ref.write(Data_Maybe.Nothing.value)(v.expiresAt)();
        Effect_Ref.write(Data_Maybe.Nothing.value)(v.user)();
        $foreign.removeStorageItem(storageKey)(v.config.tokenKey)();
        $foreign.removeStorageItem(storageKey)(v.config.refreshKey)();
        $foreign.removeStorageItem(storageKey)(v.config.userKey)();
        return setAuthState(v)(Unauthenticated.value)();
    };
};
export {
    LocalStorage,
    SessionStorage,
    MemoryOnly,
    Unauthenticated,
    Authenticating,
    Authenticated,
    Refreshing,
    Expired,
    create,
    setTokens,
    clear,
    refresh,
    getAccessToken,
    getRefreshToken,
    isAuthenticated,
    isExpired,
    getAuthState,
    onAuthStateChange,
    setUser,
    getUser,
    clearUser,
    eqStorageType,
    eqAuthState,
    showAuthState
};
