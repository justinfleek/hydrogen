// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//                                                  // hydrogen // serviceworker
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// | Service Worker registration and communication
// |
// | PWA support with service worker lifecycle management.
// |
// | ## Usage
// |
// | ```purescript
// | import Hydrogen.Offline.ServiceWorker as SW
// |
// | -- Register service worker
// | registration <- SW.register "/sw.js"
// |
// | -- Check for updates
// | SW.checkForUpdate registration
// |
// | -- Listen for state changes
// | SW.onStateChange registration \state ->
// |   case state of
// |     SW.Installing -> showToast "Installing update..."
// |     SW.Activated -> showToast "App updated!"
// |     _ -> pure unit
// |
// | -- Post message to SW
// | SW.postMessage registration { type: "SKIP_WAITING" }
// | ```
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Aff from "../Effect.Aff/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);

// | Service Worker state
var Installing = /* #__PURE__ */ (function () {
    function Installing() {

    };
    Installing.value = new Installing();
    return Installing;
})();

// | Service Worker state
var Installed = /* #__PURE__ */ (function () {
    function Installed() {

    };
    Installed.value = new Installed();
    return Installed;
})();

// | Service Worker state
var Activating = /* #__PURE__ */ (function () {
    function Activating() {

    };
    Activating.value = new Activating();
    return Activating;
})();

// | Service Worker state
var Activated = /* #__PURE__ */ (function () {
    function Activated() {

    };
    Activated.value = new Activated();
    return Activated;
})();

// | Service Worker state
var Redundant = /* #__PURE__ */ (function () {
    function Redundant() {

    };
    Redundant.value = new Redundant();
    return Redundant;
})();

// | Unregister a service worker
var unregister = function (reg) {
    return Effect_Aff.makeAff(function (callback) {
        return function __do() {
            $foreign.unregisterImpl(reg)(function (err) {
                return callback(new Data_Either.Left(err));
            })(function (success) {
                return callback(new Data_Either.Right(success));
            })();
            return Effect_Aff.nonCanceler;
        };
    });
};

// | Tell waiting service worker to skip waiting and activate
var skipWaiting = $foreign.skipWaitingImpl;
var showServiceWorkerState = {
    show: function (v) {
        if (v instanceof Installing) {
            return "installing";
        };
        if (v instanceof Installed) {
            return "installed";
        };
        if (v instanceof Activating) {
            return "activating";
        };
        if (v instanceof Activated) {
            return "activated";
        };
        if (v instanceof Redundant) {
            return "redundant";
        };
        throw new Error("Failed pattern match at Hydrogen.Offline.ServiceWorker (line 79, column 1 - line 84, column 31): " + [ v.constructor.name ]);
    }
};

// | Register a service worker
var register = function (scriptUrl) {
    return Effect_Aff.makeAff(function (callback) {
        return function __do() {
            $foreign.registerImpl(scriptUrl)(function (err) {
                return callback(new Data_Either.Left(err));
            })(function (reg) {
                return callback(new Data_Either.Right(reg));
            })();
            return Effect_Aff.nonCanceler;
        };
    });
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                               // communication
// ═══════════════════════════════════════════════════════════════════════════════
// | Post a message to the service worker
var postMessage = $foreign.postMessageImpl;

// | Listen for update found events
var onUpdateFound = $foreign.onUpdateFoundImpl;

// | Listen for state changes
var onStateChange = function (reg) {
    return function (callback) {
        var parseState = function (v) {
            if (v === "installing") {
                return Installing.value;
            };
            if (v === "installed") {
                return Installed.value;
            };
            if (v === "activating") {
                return Activating.value;
            };
            if (v === "activated") {
                return Activated.value;
            };
            if (v === "redundant") {
                return Redundant.value;
            };
            return Redundant.value;
        };
        return $foreign.onStateChangeImpl(reg)(function (stateStr) {
            return callback(parseState(stateStr));
        });
    };
};

// | Listen for messages from the service worker
var onMessage = $foreign.onMessageImpl;

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                // registration
// ═══════════════════════════════════════════════════════════════════════════════
// | Check if service workers are supported
var isSupported = $foreign.isSupportedImpl;

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                   // utilities
// ═══════════════════════════════════════════════════════════════════════════════
// | Check if page is controlled by a service worker
var isControlled = $foreign.isControlledImpl;

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                       // state
// ═══════════════════════════════════════════════════════════════════════════════
// | Get current service worker state
var getState = function (_reg) {
    return pure(Data_Maybe.Nothing.value);
};

// | Get existing registration
var getRegistration = /* #__PURE__ */ Effect_Aff.makeAff(function (callback) {
    return function __do() {
        $foreign.getRegistrationImpl(function (err) {
            return callback(new Data_Either.Left(err));
        })(function (reg) {
            return callback(new Data_Either.Right(new Data_Maybe.Just(reg)));
        })(callback(new Data_Either.Right(Data_Maybe.Nothing.value)))();
        return Effect_Aff.nonCanceler;
    };
});
var eqServiceWorkerState = {
    eq: function (x) {
        return function (y) {
            if (x instanceof Installing && y instanceof Installing) {
                return true;
            };
            if (x instanceof Installed && y instanceof Installed) {
                return true;
            };
            if (x instanceof Activating && y instanceof Activating) {
                return true;
            };
            if (x instanceof Activated && y instanceof Activated) {
                return true;
            };
            if (x instanceof Redundant && y instanceof Redundant) {
                return true;
            };
            return false;
        };
    }
};

// ═══════════════════════════════════════════════════════════════════════════════
//                                                                     // updates
// ═══════════════════════════════════════════════════════════════════════════════
// | Check for service worker updates
var checkForUpdate = function (reg) {
    return Effect_Aff.makeAff(function (callback) {
        return function __do() {
            $foreign.updateImpl(reg)(function (err) {
                return callback(new Data_Either.Left(err));
            })(callback(new Data_Either.Right(Data_Unit.unit)))();
            return Effect_Aff.nonCanceler;
        };
    });
};
export {
    Installing,
    Installed,
    Activating,
    Activated,
    Redundant,
    register,
    unregister,
    getRegistration,
    checkForUpdate,
    skipWaiting,
    onUpdateFound,
    getState,
    onStateChange,
    postMessage,
    onMessage,
    isSupported,
    isControlled,
    eqServiceWorkerState,
    showServiceWorkerState
};
